$(function(){var t=$(".order-edit-cost-form form"),r=t.find("[name='OrderEditCostParametersJson']"),a=t.find(".order-product-price-edit-table"),n=t.find(".order-cost-edit-table"),o=t.find(".transaction-amount-edit-table"),i=$(".order-edit-cost-form .total-cost");if(!(t.length&&r.length&&a.length&&n.length&&o.length))return void console.warn("init order cost editor failed:",t,r,a,n,o);var e="collectAll.orderEditCost",d="orderProductPriceChange.orderEditCost",c="orderCostChange.orderEditCost",l="transactionAmountChange.orderEditCost";t.bind(e,function(){var t={OrderProductCountMapping:{},OrderProductUnitPriceMapping:{},OrderTotalCostCalcResult:[],TransactionAmountMapping:{}},i=a.find("[data-order-product-id]").closest("tr");i.each(function(){var r=$(this),a=r.find("[data-order-product-id]").data("order-product-id"),n=r.find(".price").val(),o=r.find(".order-count").val();t.OrderProductUnitPriceMapping[a]=n,t.OrderProductCountMapping[a]=o});var e=n.find("[data-row]");e.each(function(){var r=$(this);t.OrderTotalCostCalcResult.push({Delta:r.find(".part-delta").val(),Type:r.data("row").OrderPricePartType})});var d=o.find("[data-row]");d.each(function(){var r=$(this),a=r.data("row").PaymentTransactionId,n=r.find(".transaction-amount").val();t.TransactionAmountMapping[a]=n}),r.val(JSON.stringify(t)),console.log(t)}),t.bind(d,function(){var r=a.find("[data-order-product-id]").closest("tr"),o=0;r.each(function(){var t=$(this),r=parseFloat(t.find(".price").val())||0,a=parseInt(t.find(".order-count").val())||0;o+=r*a});var i=n.find("[data-row]").filter(function(){return"ProductTotalPrice"==$(this).data("row").OrderPricePartType}).find(".part-delta");i.val(o.toFixed(2)).change(),t.trigger(e)}),a.find(".price, .order-count").on("change",function(){t.trigger(d)});var f=function(){var t=n.find("[data-row] .part-delta"),r=0;return t.each(function(){r+=parseFloat($(this).val())||0}),i.text(r.toFixed(2)),r};f(),t.bind(c,function(){var r=f(),a=o.find("[data-row] .transaction-amount"),n=0;_.each(_.tail(a),function(){n+=parseFloat($(this).val())}),a.first().val((r-n).toFixed(2)).change(),t.trigger(e)}),n.find("[data-row] .part-delta").on("change",function(){t.trigger(c)}),t.bind(l,function(){t.trigger(e)}),o.find("[data-row] .transaction-amount").on("change",function(){t.trigger(l)}),t.trigger(e)});