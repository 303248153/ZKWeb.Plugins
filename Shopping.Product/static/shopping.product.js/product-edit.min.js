$.fn.productMatchedDataEditor=function(){var $editor=$(this);if($editor.data("initialized"))return!0;$editor.data("initialized",!0);var $categoryId=$editor.closest("form").find("[name='"+$editor.attr("data-category-id-name")+"']"),$matchedDataJson=$editor.closest("form").find("[name='"+$editor.attr("data-matched-datas-name")+"']");if(!$categoryId.length||!$matchedDataJson.length)return void console.warn("init product matched data editor failed",$categoryId,$matchedDataJson);var bindLockName="bindLock.editableTable",binders={ConditionBinders:null,AffectsBinders:null},addRowEventName="addRow.editableTable",bindEventName="bind.editableTable",collectEventName="collect.editableTable",conditionCellUpdateEventName="update.productMatchedDataEditor",tableClass=$editor.data("table-class"),tableHeaderClass=$editor.data("table-header-class"),$table=$editor.editableTable({tableClass:tableClass,tableHeaderClass:tableHeaderClass});$table.on(bindEventName,function(){$table.data(bindLockName,!0);var t=JSON.parse($matchedDataJson.val()||"[]");t.length&&$.isEmptyObject(_.last(t).Conditions)||t.push({}),$matchedDataJson.val(JSON.stringify(t));var e=$table.find("thead > tr").empty(),a=$table.find("tbody").empty(),n=$editor.data("translations")||{};e.append($("<th width='30%'>").append(n.Condition||"Condition")),_.each(binders.AffectsBinders,function(t){e.append($("<th>").addClass("heading").append(t.Header))}),e.append($table.data("actionsHead").clone()),$table.off(addRowEventName).on(addRowEventName,function(t,e){var i=$("<tr>"),o=$("<td class='condition-cell'><span class='condition-string'></span><div class='btn-group'><a data-toggle='dropdown' class='btn-xs btn-primary'><i class='fa fa-pencil'></i></a><ul class='dropdown-menu'><div class='form form-horizontal'><div class='form-body'></div></div></ul></div></td>"),d=o.find(".form");_.each(binders.ConditionBinders,function(t){var a=$("<div class='condition-binder'>").append(t.Contents);t.BindFunction(a,e.Conditions||{}),a.data("CollectFunction",t.CollectFunction),a.data("DisplayFunction",t.DisplayFunction),d.append(a)}),o.on(conditionCellUpdateEventName,function(){var t="";o.find(".condition-binder").each(function(){var a=$(this);t+=a.data("DisplayFunction")(a,e.Conditions||{}),t+=" "}),o.find(".condition-string").text(t.trim()||n.Default||"Default")}),o.trigger(conditionCellUpdateEventName),i.append(o),_.each(binders.AffectsBinders,function(t){var a=$("<td class='affects-binder'>").append(t.Contents);t.BindFunction(a,e.Affects||{}),a.data("CollectFunction",t.CollectFunction),i.append(a)}),i.append($table.data("actionsCell").clone()),$.isEmptyObject(e)?a.prepend(i):a.append(i)}),_.each(t,function(t){$table.trigger(addRowEventName,[t])}),$table.find("> tbody > tr").last().find(".condition-cell .btn-group").hide(),$table.data(bindLockName,!1)}),$table.on(collectEventName,function(){if(!$table.data(bindLockName)){var t=[],e=$table.find("tbody > tr");e.each(function(){var e=$(this),a={Conditions:{},Affects:{}};e.find(".condition-cell").trigger(conditionCellUpdateEventName),e.find(".condition-binder").each(function(){var t=$(this);t.data("CollectFunction")(t,a.Conditions)}),e.find(".affects-binder").each(function(){var t=$(this);t.data("CollectFunction")(t,a.Affects)}),t.push(a)}),$matchedDataJson.val(JSON.stringify(t))}});var onCategoryIdChanged=function(){var categoryId=$categoryId.val(),previousCategoryId=$editor.data("categoryId");previousCategoryId!=categoryId&&($editor.data("categoryId",categoryId),$.get("/api/product/matched_data_binders?categoryId="+categoryId,function(remoteBinders){var evalFunc=function(body){return eval("("+body+" || function() {})")};_.each(remoteBinders.ConditionBinders,function(t){t.BindFunction=evalFunc(t.Bind),t.CollectFunction=evalFunc(t.Collect),t.DisplayFunction=evalFunc(t.Display)}),_.each(remoteBinders.AffectsBinders,function(t){t.BindFunction=evalFunc(t.Bind),t.CollectFunction=evalFunc(t.Collect)}),binders=remoteBinders,previousCategoryId&&previousCategoryId!=categoryId&&$matchedDataJson.val(""),$table.trigger(bindEventName)}))};$categoryId.on("change",onCategoryIdChanged),onCategoryIdChanged.call($categoryId)},$(function(){var t=function(t){t.each(function(){$(this).productMatchedDataEditor()})},e="[data-toggle='product-matched-data-editor']";t($(e)),$(document).on("dynamicLoaded",function(a,n){t($(n).find(e))})}),$.fn.productToPropertyValuesEditor=function(){var t=$(this);if(t.data("initialized"))return!0;t.data("initialized",!0);var e=t.closest("form").find("[name='"+t.attr("data-category-id-name")+"']"),a=t.closest("form").find("[name='"+t.attr("data-property-values-name")+"']");if(!e.length||!a.length)return void console.warn("init product property editor failed",e,a);var n="bind.productToPropertyValuesEditor",i="bindingLock",o="data-property-type",d="["+o+"]",r=function(t,e){var a=t.text().trim()!=e.trim();a&&t.text(e).css("color","#31708F")};t.on(n,function(){t.data(i,!0);var e=JSON.parse(a.val()||"[]"),n=_.groupBy(e,"propertyId");t.find(d).each(function(){var t=$(this),e=t.attr(o),a=t.data("property-id");if("textbox"==e){var i=_.first(n[a]);t.find("input[type='text']").val(i?i.name:"").change()}else if("checkbox"==e){var d=_.indexBy(n[a],"propertyValueId");t.find("input[type='checkbox']").each(function(){var t=$(this),e=d[t.val()];t.prop("checked",e?!0:!1).change(),e&&r(t.parent().find(".alias-text"),e.name)})}else if("dropdown-list"==e){var i=_.first(n[a]);t.find("select").val(i?i.propertyValueId:"").change()}else if("editable-dropdown-list"==e){var i=_.first(n[a]);t.find("select").val(i?i.propertyValueId:"").change(),t.find("input[type='text']").val(i?i.name:"").change()}}),t.data(i,!1)});var c="collect.productToPropertyValuesEditor";t.on(c,function(){if(!t.data(i)){var e=[];t.find(d).each(function(){var t=$(this),a=t.attr(o),n=t.data("property-id");if("textbox"==a){var i=t.find("input[type='text']").val();i&&e.push({propertyId:n,name:i})}else if("checkbox"==a)t.find("input[type='checkbox']:checked").each(function(){var t=$(this),a=t.parent().find(".alias-text").text().trim(),i=t.val();i&&e.push({propertyId:n,propertyValueId:i,name:a})});else if("dropdown-list"==a){var d=t.find("select"),r=d.find("option:selected").text().trim(),i=d.val();i&&e.push({propertyId:n,propertyValueId:i,name:r})}else if("editable-dropdown-list"==a){var d=t.find("select"),r=t.find("input[type='text']").val().trim(),c=d.find("option:selected").text().trim(),i=r==c?d.val():"";r&&e.push({propertyId:n,propertyValueId:i,name:r})}else console.warn("unknow property type",a)}),a.val(JSON.stringify(e))}});var l=t.data("translations")||{},s=function(){var i=e.val(),o=t.data("categoryId"),s="Sure to change category? The properties you selected will lost!";return o&&o!=i&&!confirm(l[s]||s)?(e.val(o),!1):(t.data("categoryId",i),void t.load("/api/product/property_editor?categoryId="+i,function(){var e=".property-value-alias";t.find(e+" .alias-edit-btn").on("click",function(){var t=$(this).closest(e),a=t.find(".alias-editor"),n=t.find(".alias-text");return t.toggleClass("editing").hasClass("editing")&&a.val(n.text()),!1}),t.find(e+" .alias-editor").on("change",function(){var t=$(this),a=t.closest(e);r(a.find(".alias-text"),t.val())}),t.find(e).on("click",function(){return $(this).hasClass("editing")?!1:null}),o&&o!=i&&a.val(""),t.trigger(n),t.find(d).find("input, select").on("change",function(){t.trigger(c)})}))};e.on("change",s),s.call(e)},$(function(){var t=function(t){t.each(function(){$(this).productToPropertyValuesEditor()})},e="[data-toggle='product-to-property-values-editor']";t($(e)),$(document).on("dynamicLoaded",function(a,n){t($(n).find(e))})}),$(function(){var t=null,e=null,a=function(){if(t&&e){var a={};e.find("[data-property-type]").each(function(){var t=$(this),e=t.attr("data-property-type"),n=t.data("property-id");if("checkbox"==e){var i=[];t.find("input[type='checkbox']:checked").each(function(){var t=$(this),e=t.parent().find(".alias-text"),a=e.text().trim(),n=e.css("color"),o=t.val();o&&i.push({propertyValueId:o,name:a,color:n})}),a[n]=i}}),t.find(".condition-binder [data-property-id]").each(function(){var t=$(this),e=t.data("property-id"),n=_.indexBy(a[e],"propertyValueId");t.find("option").each(function(){var t=$(this);if(t.val()){var e=n[t.val()];e?t.show():t.hide(),e&&t.text(e.name)}})}),t.find(".condition-cell").trigger("update.productMatchedDataEditor")}};$(document).on("bind.editableTable",".product-matched-data-editor table",function(){t=$(this),a()}),$(document).on("collect.editableTable",".product-matched-data-editor table",function(){t=$(this),a()}),$(document).on("bind.productToPropertyValuesEditor",".product-to-property-values-editor",function(){e=$(this),a()}),$(document).on("collect.productToPropertyValuesEditor",".product-to-property-values-editor",function(){e=$(this),a()})});