$.fn.productMatchedDataEditor=function(){var $editor=$(this);if($editor.data("initialized"))return!0;$editor.data("initialized",!0);var $categoryId=$editor.closest("form").find("[name='"+$editor.attr("data-category-id-name")+"']"),$matchedDataJson=$editor.closest("form").find("[name='"+$editor.attr("data-matched-datas-name")+"']");if(!$categoryId.length||!$matchedDataJson.length)return void console.warn("init product matched data editor failed",$categoryId,$matchedDataJson);var bindEventName="bind.productMatchedDataEditor",bindingLockName="bindingLock",binders={ConditionBinders:null,AffectsBinders:null},collectEventName="collect.productMatchedDataEditor",conditionCellUpdateEventName="update.productMatchedDataEditor";$editor.on(bindEventName,function(){$editor.data(bindingLockName,!0);var t=JSON.parse($matchedDataJson.val()||"[]");t.length&&$.isEmptyObject(_.last(t).Conditions)||t.push({}),$matchedDataJson.val(JSON.stringify(t)),$editor.html("<table><thead><tr></tr></thead><tbody></tbody></table>");var a=$editor.find("table"),n=a.find("thead > tr"),e=a.find("tbody");a.addClass($editor.attr("data-table-class")),n.addClass($editor.attr("data-table-header-class"));var i=$editor.data("translations")||{};n.append($("<th width='30%'>").append(i.Condition||"Condition")),_.each(binders.AffectsBinders,function(t){n.append($("<th>").append(t.Header))}),n.append($("<th width='100'>").append($("<div class='actions'>").append("<a class='btn-xs btn-primary add-data'><i class='fa fa-plus'></i></a>")));var o=function(t,a){var n=$("<tr>"),o=$("<td class='condition-cell'><span class='condition-string'></span><div class='btn-group'><a data-toggle='dropdown' class='btn-xs btn-primary'><i class='fa fa-pencil'></i></a><ul class='dropdown-menu'><div class='form form-horizontal'><div class='form-body'></div></div></ul></div></td>"),d=o.find(".form");_.each(binders.ConditionBinders,function(a){var n=$("<div class='condition-binder'>").append(a.Contents);a.BindFunction(n,t.Conditions||{}),n.data("CollectFunction",a.CollectFunction),n.data("DisplayFunction",a.DisplayFunction),d.append(n)}),o.on(conditionCellUpdateEventName,function(){var a="";o.find(".condition-binder").each(function(){var n=$(this);a+=n.data("DisplayFunction")(n,t.Conditions||{}),a+=" "}),o.find(".condition-string").text(a.trim()||i.Default||"Default")}),o.trigger(conditionCellUpdateEventName),n.append(o),_.each(binders.AffectsBinders,function(a){var e=$("<td class='affects-binder'>").append(a.Contents);a.BindFunction(e,t.Affects||{}),e.data("CollectFunction",a.CollectFunction),n.append(e)}),n.append($("<td>").append($("<div class='actions'>").append("<a class='btn-xs btn-primary up-data'><i class='fa fa-arrow-up'></i></a>").append("<a class='btn-xs btn-primary down-data'><i class='fa fa-arrow-down'></i></a>").append("<a class='btn-xs btn-primary remove-data'><i class='fa fa-remove'></i></a>"))),n.find("input, select").on("change",function(){$editor.trigger(collectEventName)}),n.find(".actions .up-data").on("click",function(){var t=n.prev();t.length&&t.before(n),$editor.trigger(collectEventName)}),n.find(".actions .down-data").on("click",function(){var t=n.next();t.length&&t.after(n),$editor.trigger(collectEventName)}),n.find(".actions .remove-data").on("click",function(){n.remove(),$editor.trigger(collectEventName)}),a?e.prepend(n):e.append(n)};_.each(t,function(t){o(t)}),a.find("> tbody > tr").last().find(".condition-cell .btn-group").hide(),a.find(".add-data").off("click").on("click",function(){o({},!0),$editor.trigger(collectEventName)}),$editor.data(bindingLockName,!1)}),$editor.on(collectEventName,function(){if(!$editor.data(bindingLockName)){var t=[],a=$editor.find("table > tbody > tr");a.each(function(){var a=$(this),n={Conditions:{},Affects:{}};a.find(".condition-cell").trigger(conditionCellUpdateEventName),a.find(".condition-binder").each(function(){var t=$(this);t.data("CollectFunction")(t,n.Conditions)}),a.find(".affects-binder").each(function(){var t=$(this);t.data("CollectFunction")(t,n.Affects)}),t.push(n)}),$matchedDataJson.val(JSON.stringify(t))}});var onCategoryIdChanged=function(){var categoryId=$categoryId.val(),previousCategoryId=$editor.data("categoryId");previousCategoryId!=categoryId&&($editor.data("categoryId",categoryId),$.get("/product/matched_data_binders?categoryId="+categoryId,function(remoteBinders){var evalFunc=function(body){return eval("("+body+" || function() {})")};_.each(remoteBinders.ConditionBinders,function(t){t.BindFunction=evalFunc(t.Bind),t.CollectFunction=evalFunc(t.Collect),t.DisplayFunction=evalFunc(t.Display)}),_.each(remoteBinders.AffectsBinders,function(t){t.BindFunction=evalFunc(t.Bind),t.CollectFunction=evalFunc(t.Collect)}),binders=remoteBinders,previousCategoryId&&previousCategoryId!=categoryId&&$matchedDataJson.val(""),$editor.trigger(bindEventName)}))};$categoryId.on("change",onCategoryIdChanged),onCategoryIdChanged.call($categoryId)},$(function(){var t=function(t){t.each(function(){$(this).productMatchedDataEditor()})},a="[data-toggle='product-matched-data-editor']";t($(a)),$(document).on("dynamicLoaded",function(n,e){t($(e).find(a))})}),$.fn.productPropertyEditor=function(){var t=$(this);if(t.data("initialized"))return!0;t.data("initialized",!0);var a=t.closest("form").find("[name='"+t.attr("data-category-id-name")+"']"),n=t.closest("form").find("[name='"+t.attr("data-property-values-name")+"']");if(!a.length||!n.length)return void console.warn("init product property editor failed",a,n);var e="bind.productPropertyEditor",i="bindingLock",o="data-property-type",d="["+o+"]",r=function(t,a){var n=t.text().trim()!=a.trim();n&&t.text(a).css("color","#31708F")};t.on(e,function(){t.data(i,!0);var a=JSON.parse(n.val()||"[]"),e=_.groupBy(a,"propertyId");t.find(d).each(function(){var t=$(this),a=t.attr(o),n=t.data("property-id");if("textbox"==a){var i=_.first(e[n]);t.find("input[type='text']").val(i?i.name:"").change()}else if("checkbox"==a){var d=_.indexBy(e[n],"propertyValueId");t.find("input[type='checkbox']").each(function(){var t=$(this),a=d[t.val()];t.prop("checked",a?!0:!1).change(),a&&r(t.parent().find(".alias-text"),a.name)})}else if("dropdown-list"==a){var i=_.first(e[n]);t.find("select").val(i?i.propertyValueId:"").change()}else if("editable-dropdown-list"==a){var i=_.first(e[n]);t.find("select").val(i?i.propertyValueId:"").change(),t.find("input[type='text']").val(i?i.name:"").change()}}),t.data(i,!1)});var c="collect.productPropertyEditor";t.on(c,function(){if(!t.data(i)){var a=[];t.find(d).each(function(){var t=$(this),n=t.attr(o),e=t.data("property-id");if("textbox"==n){var i=t.find("input[type='text']").val();i&&a.push({propertyId:e,name:i})}else if("checkbox"==n)t.find("input[type='checkbox']:checked").each(function(){var t=$(this),n=t.parent().find(".alias-text").text().trim(),i=t.val();i&&a.push({propertyId:e,propertyValueId:i,name:n})});else if("dropdown-list"==n){var d=t.find("select"),r=d.find("option:selected").text().trim(),i=d.val();i&&a.push({propertyId:e,propertyValueId:i,name:r})}else if("editable-dropdown-list"==n){var d=t.find("select"),r=t.find("input[type='text']").val().trim(),c=d.find("option:selected").text().trim(),i=r==c?d.val():"";r&&a.push({propertyId:e,propertyValueId:i,name:r})}else console.warn("unknow property type",n)}),n.val(JSON.stringify(a))}});var l=t.data("translations")||{},s=function(){var i=a.val(),o=t.data("categoryId"),s="Sure to change category? The properties you selected will lost!";return o&&o!=i&&!confirm(l[s]||s)?(a.val(o),!1):(t.data("categoryId",i),void t.load("/product/property_editor?categoryId="+i,function(){var a=".property-value-alias";t.find(a+" .alias-edit-btn").on("click",function(){var t=$(this).closest(a),n=t.find(".alias-editor"),e=t.find(".alias-text");return t.toggleClass("editing").hasClass("editing")&&n.val(e.text()),!1}),t.find(a+" .alias-editor").on("change",function(){var t=$(this),n=t.closest(a);r(n.find(".alias-text"),t.val())}),t.find(a).on("click",function(){return $(this).hasClass("editing")?!1:null}),o&&o!=i&&n.val(""),t.trigger(e),t.find(d).find("input, select").on("change",function(){t.trigger(c)})}))};a.on("change",s),s.call(a)},$(function(){var t=function(t){t.each(function(){$(this).productPropertyEditor()})},a="[data-toggle='product-property-editor']";t($(a)),$(document).on("dynamicLoaded",function(n,e){t($(e).find(a))})}),$(function(){var t=null,a=null,n=function(){if(t&&a){var n={};a.find("[data-property-type]").each(function(){var t=$(this),a=t.attr("data-property-type"),e=t.data("property-id");if("checkbox"==a){var i=[];t.find("input[type='checkbox']:checked").each(function(){var t=$(this),a=t.parent().find(".alias-text"),n=a.text().trim(),e=a.css("color"),o=t.val();o&&i.push({propertyValueId:o,name:n,color:e})}),n[e]=i}}),t.find(".condition-binder [data-property-id]").each(function(){var t=$(this),a=t.data("property-id"),e=_.indexBy(n[a],"propertyValueId");t.find("option").each(function(){var t=$(this);if(t.val()){var a=e[t.val()];a?t.show():t.hide(),a&&t.text(a.name)}})}),t.find(".condition-cell").trigger("update.productMatchedDataEditor")}};$(document).on("bind.productMatchedDataEditor",".product-matched-data-editor",function(){t=$(this),n()}),$(document).on("collect.productMatchedDataEditor",".product-matched-data-editor",function(){t=$(this),n()}),$(document).on("bind.productPropertyEditor",".product-property-editor",function(){a=$(this),n()}),$(document).on("collect.productPropertyEditor",".product-property-editor",function(){a=$(this),n()})});